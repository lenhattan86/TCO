clc;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                          INPUT                                 %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Load the common settings.
init_common_settings;
IS_OFFICIAL = 1;

RUN_NON_DR = 0;
RUN_TOU    = 0;
RUN_CPP    = 0;
RUN_IBR    = 0; 
RUN_SR     = 1;
RUN_BiMarkets = 0;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                          SOLVER                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
plot_option     = 1;
nz = 0; % do not use net-zero
% GP = 0.07*ones(1,T);
%%
if RUN_NON_DR || IS_OFFICIAL
    close all;
    % grid only
    % [cost_grid,capacity_grid,emission_grid] = houston_grid_dr(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP,RP,BP,plot_option,[fig_path 'nz-grid_NoDR']);
    % 

    % supply only
%     [cost_supply,capacity_supply,emission_supply] = houston_grid_dr(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP,RP,BP,plot_option,[fig_path 'nz-supply_NoDR']);

    % demand only
%     [cost_demand,capacity_demand,emission_demand] = houston_grid_dr(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP,RP,BP,plot_option,[fig_path 'nz-demand_NoDR']);

    % integrated
    [cost_int,capacity_int,emission_int] = houston_grid_dr(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP,RP,BP,plot_option,[fig_path 'nz-int_NoDR']);
end
%% TOU
if RUN_TOU || IS_OFFICIAL
    % grid only
    % [cost_grid,capacity_grid,emission_grid] = houston_grid_dr(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP_TOU,RP,BP,plot_option,[fig_path 'nz-grid_tou']);
    % 

    % supply only
%     [cost_supply_tou,capacity_supply_tou,emission_supply_tou] = houston_grid_tou(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP_TOU,RP,BP,plot_option,[fig_path 'nz-supply_tou']);

    % demand only
%     [cost_demand_tou,capacity_demand_tou,emission_demand_tou] = houston_grid_tou(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP_TOU,RP,BP,plot_option,[fig_path 'nz-demand_tou']);

    % integrated
    [cost_int_tou,capacity_int_tou,emission_int_tou] = houston_grid_tou(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP_TOU,RP,BP,plot_option,[fig_path 'nz-int_tou']);
end
%% CPP
if RUN_CPP || IS_OFFICIAL
    
    % grid only
    % [cost_grid_cpp,capacity_grid_cpp,emission_grid_cpp] = houston_grid_cpp(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
    %     plot_option,[fig_path 'nz-grid_sr']);

    % supply only
%     [cost_supply_cpp,capacity_supply_cpp,emission_supply_cpp] = houston_grid_cpp(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP,RP,BP,...
%         cpp_rates ,...
%         plot_option,[fig_path 'nz-supply_cpp']);

    % demand only
%     [cost_demand_cpp,capacity_demand_cpp,emission_demand_cpp] = houston_grid_cpp(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP,RP,BP,...
%         cpp_rates ,...
%         plot_option,[fig_path 'nz-demand_cpp']);
%     cpp_rates = zeros(1,T);
    % integrated
    [cost_int_cpp,capacity_int_cpp,emission_int_cpp] = houston_grid_cpp(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP,RP,BP, ...
        cpp_rates ,...
        plot_option,[fig_path 'nz-int_cpp']);
end

%% IBR
if RUN_IBR || IS_OFFICIAL
    % grid only
    % [cost_grid_ibr,capacity_grid_ibr,emission_grid_ibr] = houston_grid_IBR(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
    %     plot_option,[fig_path 'nz-grid_ibr']);

    % supply only
%     [cost_supply_ibr,capacity_supply_ibr,emission_supply_ibr] = houston_grid_IBR(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
%         plot_option,[fig_path 'nz-supply_ibr']);

    % demand only
%     [cost_demand_ibr,capacity_demand_ibr,emission_demand_ibr] = houston_grid_IBR(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
%         plot_option,[fig_path 'nz-demand_ibr']);
    
    % integrated
    [cost_int_ibr,capacity_int_ibr,emission_int_ibr] = houston_grid_IBR(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP,RP,BP, ibr_levels, ibr_rates ,...
        plot_option,[fig_path 'nz-int_ibr']);
end

%% Ancillary Service
% Spinning service
%% IBR
if RUN_SR || IS_OFFICIAL
%     sr_rates = zeros(1,T);
    % grid only
    % [cost_grid_ibr,capacity_grid_ibr,emission_grid_ibr] = houston_grid_SR(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
    %     plot_option,[fig_path 'nz-grid_sr']);

    % supply only
%     [cost_supply_sr,capacity_supply_sr,emission_supply_sr] = houston_grid_SR(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP,RP,BP, sr_rates ,...
%         plot_option,[fig_path 'nz-supply_sr']);

    % demand only
%     [cost_demand_sr,capacity_demand_sr,emission_demand_sr] = houston_grid_SR(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP,RP,BP, sr_rates ,...
%         plot_option,[fig_path 'nz-demand_sr']);
    
    % integrated
    [cost_int_sr,capacity_int_sr,emission_int_sr] = houston_grid_SR(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP,RP,BP, sr_rates ,...
        plot_option,[fig_path 'nz-int_sr']);
end
%% Wholesale markets
% Bilateral markets
if RUN_BiMarkets || IS_OFFICIAL
    % grid only
    % [cost_grid_ibr,capacity_grid_ibr,emission_grid_ibr] = houston_grid_BiMarkets(0,0,0,0,T,IP,PP,OP,...
    %     IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),[0,0],RC,RE,SR,[0,0],CRC,...
    %     CRE,P,GP,RP,BP, ibr_levels, ibr_rates ,...
    %     plot_option,[fig_path 'nz-grid_BiMarkets']);

    % supply only
%     [cost_supply_BiMarkets,capacity_supply_BiMarkets,emission_supply_BiMarkets] = houston_grid_BiMarkets(0,nz,0,0,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE,R(1,:),RR,RC,RE,SR,CRR,CRC,...
%         CRE,P,GP,RP,BP, ...
%         DC_power ,bi_power_ratio, bi_rate,...
%         plot_option,[fig_path 'nz-supply_BiMarkets']);

    % demand only
%     [cost_demand_BiMarkets,capacity_demand_BiMarkets,emission_demand_BiMarkets] = houston_grid_BiMarkets(1,nz,1,1,T,IP,...
%         PP,OP,IT,CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),...
%         0.7*[DC_power,DC_power],RC,RE,SR,[DC_power,DC_power],CRC,...
%         CRE,P,GP,RP,BP, ...
%         DC_power ,bi_power_ratio, bi_rate ,...
%         plot_option,[fig_path 'nz-demand_BiMarkets']);
    
    % integrated
    [cost_int_BiMarkets,capacity_int_BiMarkets,emission_int_BiMarkets] = houston_grid_BiMarkets(1,nz,1,1,T,IP,PP,OP,IT,...
        CO2_grid,a,au,con,BS,A,S,E,bu,PUE_low,R(1,:),RR,RC,RE,SR,CRR,CRC,CRE,...
        P,GP,RP,BP, ...
        DC_power ,bi_power_ratio, bi_rate ,...
        plot_option,[fig_path 'nz-int_BiMarkets']);
end
%%

if (IS_OFFICIAL) 
    save('results/TCO_DR_evaluation.mat'); 
    close all;
end